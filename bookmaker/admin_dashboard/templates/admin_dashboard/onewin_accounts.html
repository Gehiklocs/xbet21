{% extends 'admin_dashboard/base.html' %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-white">1Win Accounts</h2>
    <a href="{% url 'admin_onewin_account_add' %}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">
        <i class="fas fa-plus mr-2"></i> Add Account
    </a>
</div>

<!-- Search and Filter -->
<div class="bg-slate-900 p-4 rounded-xl border border-slate-800 mb-6">
    <form method="get" class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
            <input type="text" name="q" value="{{ query|default:'' }}" placeholder="Search accounts..."
                   class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
        </div>
        <div class="w-full md:w-48">
            <select name="status" class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                <option value="">All Statuses</option>
                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                <option value="logged_in" {% if status_filter == 'logged_in' %}selected{% endif %}>Logged In</option>
                <option value="banned" {% if status_filter == 'banned' %}selected{% endif %}>Banned</option>
                <option value="suspended" {% if status_filter == 'suspended' %}selected{% endif %}>Suspended</option>
                <option value="needs_verification" {% if status_filter == 'needs_verification' %}selected{% endif %}>Needs Verification</option>
                <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
            </select>
        </div>
        <button type="submit" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-2 rounded-lg transition border border-slate-700">
            Filter
        </button>
    </form>
</div>

<!-- Accounts Table -->
<div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr class="bg-slate-800/50 text-slate-400 text-sm uppercase">
                    <th class="px-6 py-4 font-semibold">Account Details</th>
                    <th class="px-6 py-4 font-semibold">Balance & Stats</th>
                    <th class="px-6 py-4 font-semibold">Proxy Info</th>
                    <th class="px-6 py-4 font-semibold">Session Details</th>
                    <th class="px-6 py-4 font-semibold">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
                {% for account in accounts %}
                {% with session=account.browser_session %}
                <tr class="hover:bg-slate-800/30 transition">
                    <!-- Account Details Column -->
                    <td class="px-6 py-4">
                        <div class="space-y-2">
                            <div class="font-medium text-white text-lg">{{ account.username }}</div>
                            {% if account.email %}
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-envelope w-4 text-slate-500 mr-1"></i> {{ account.email }}
                            </div>
                            {% endif %}
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-calendar w-4 text-slate-500 mr-1"></i> Created: {{ account.created_at|date:"Y-m-d H:i" }}
                            </div>
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-clock w-4 text-slate-500 mr-1"></i> Last Used: {{ account.last_used|date:"Y-m-d H:i"|default:"Never" }}
                            </div>
                            <div class="text-sm">
                                <span class="px-2 py-1 rounded text-xs font-bold
                                    {% if account.status == 'active' %}bg-emerald-500/10 text-emerald-500
                                    {% elif account.status == 'logged_in' %}bg-blue-500/10 text-blue-500
                                    {% elif account.status == 'banned' %}bg-red-500/10 text-red-500
                                    {% elif account.status == 'suspended' %}bg-orange-500/10 text-orange-500
                                    {% elif account.status == 'needs_verification' %}bg-yellow-500/10 text-yellow-500
                                    {% else %}bg-slate-500/10 text-slate-500{% endif %}">
                                    {{ account.get_status_display }}
                                </span>
                            </div>
                        </div>
                    </td>

                    <!-- Balance & Stats Column -->
                    <td class="px-6 py-4">
                        <div class="space-y-2">
                            <div class="text-xl font-mono text-emerald-400">${{ account.balance }}</div>
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-sign-in-alt w-4 text-slate-500 mr-1"></i> Logins: {{ account.login_count }}
                            </div>
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-check-circle w-4 text-emerald-500 mr-1"></i> Successful: {{ account.successful_logins }}
                            </div>
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-times-circle w-4 text-red-500 mr-1"></i> Failed: {{ account.login_count|add:"-"|add:account.successful_logins }}
                            </div>
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-chart-line w-4 text-slate-500 mr-1"></i> Success Rate:
                                {% if account.login_count > 0 %}
                                    {{ account.successful_logins|floatformat:0 }}/{{ account.login_count }}
                                    ({{ account.successful_logins|divisibleby:account.login_count|floatformat:1 }}%)
                                {% else %}
                                    0%
                                {% endif %}
                            </div>
                        </div>
                    </td>

                    <!-- Proxy Info Column -->
                    <td class="px-6 py-4">
                        {% if account.proxy %}
                        <div class="space-y-2">
                            <div class="text-sm">
                                <span class="px-2 py-1 rounded text-xs font-bold
                                    {% if account.proxy.is_active %}bg-emerald-500/10 text-emerald-500{% else %}bg-red-500/10 text-red-500{% endif %}">
                                    {{ account.proxy.is_active|yesno:"Active,Inactive" }}
                                </span>
                            </div>
                            <div class="text-sm text-slate-300 font-mono">{{ account.proxy.ip }}:{{ account.proxy.port }}</div>
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-globe w-4 text-slate-500 mr-1"></i> Type: {{ account.proxy.type|upper }}
                            </div>
                            {% if account.proxy.username %}
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-user w-4 text-slate-500 mr-1"></i> Auth: {{ account.proxy.username }}
                            </div>
                            {% endif %}
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-clock w-4 text-slate-500 mr-1"></i> Last Check: {{ account.proxy.last_checked|date:"Y-m-d H:i"|default:"Never" }}
                            </div>
                            {% if account.proxy.response_time %}
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-tachometer-alt w-4 text-slate-500 mr-1"></i> Response: {{ account.proxy.response_time }}ms
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="text-sm text-slate-500 italic">No proxy assigned</div>
                        {% endif %}
                    </td>

                    <!-- Session Details Column -->
                    <td class="px-6 py-4">
                        {% if session %}
                        <div class="space-y-2">
                            <!-- Session Status -->
                            <div>
                                <span class="px-2 py-1 rounded text-xs font-bold
                                    {% if session.session_status == 'active' %}bg-emerald-500/10 text-emerald-500
                                    {% elif session.session_status == 'needs_login' %}bg-red-500/10 text-red-500
                                    {% elif session.session_status == 'expired' %}bg-orange-500/10 text-orange-500
                                    {% elif session.session_status == 'closed' %}bg-slate-500/10 text-slate-500
                                    {% else %}bg-slate-500/10 text-slate-500{% endif %}">
                                    {{ session.get_session_status_display }}
                                </span>
                            </div>

                            <!-- Profile Info -->
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-folder w-4 text-slate-500 mr-1"></i> Profile:
                                <span class="text-slate-300 font-mono text-xs">{{ session.profile_path|default:"Not set"|truncatechars:20 }}</span>
                            </div>

                            <!-- Browser Memory Status -->
                            {% if session_key in session_manager.active_sessions %}
                            <div class="text-sm">
                                <span class="text-emerald-500">
                                    <i class="fas fa-check-circle mr-1"></i> In Memory
                                </span>
                            </div>
                            {% endif %}

                            <!-- Session Timestamps -->
                            <!-- Session Timestamps -->
<div class="text-sm text-slate-400">
    <i class="fas fa-play w-4 text-slate-500 mr-1"></i> Started: {{ session.created_at|date:"Y-m-d H:i"|default:"Not started" }}
</div>
<div class="text-sm text-slate-400">
    <i class="fas fa-stop w-4 text-slate-500 mr-1"></i> Last Active: {{ session.last_used|date:"Y-m-d H:i"|default:"Never" }}
</div>

                            <!-- Session Data -->
                            {% if session.session_state %}
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-database w-4 text-slate-500 mr-1"></i> State:
                                <span class="text-emerald-500">Saved</span>
                               {% if session.session_state_datetime %}
    <span class="text-xs text-slate-500 ml-1">({{ session.session_state_datetime|timesince }} ago)</span>
{% endif %}
                            </div>

                            <!-- Last URL -->
                            {% if session.session_state.url %}
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-link w-4 text-slate-500 mr-1"></i> Last URL:
                                <span class="text-slate-300 text-xs truncate max-w-[150px] block">{{ session.session_state.url }}</span>
                            </div>
                            {% endif %}

                            <!-- Cookies Count -->
                            {% if session.session_state.cookies %}
                            <div class="text-sm text-slate-400">
                                <i class="fas fa-cookie w-4 text-slate-500 mr-1"></i> Cookies: {{ session.session_state.cookies|length }}
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="text-sm text-slate-500 italic">No saved state</div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="text-sm text-slate-500 italic">No session created yet</div>
                        {% endif %}
                    </td>

                    <!-- Actions Column -->
                    <td class="px-6 py-4">
                        <div class="flex flex-col gap-2">
                            <!-- Open Browser -->
                            <a href="{% url 'admin_onewin_account_open_browser' account.id %}"
                               class="group relative inline-flex items-center justify-between w-full px-3 py-2 rounded-lg bg-slate-800 text-emerald-400 hover:bg-emerald-500/20 hover:text-emerald-300 transition-all shadow-md hover:shadow-lg"
                               title="Open a new browser session for this account">
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-desktop"></i>
                                    <span class="text-sm font-medium">Open Browser</span>
                                </span>
                                <span class="text-xs text-slate-500">Launch</span>
                                <span class="absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-slate-800 text-xs text-white rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap border border-slate-700 pointer-events-none z-50">
                                    Opens a visible Chrome window with full state restoration
                                </span>
                            </a>

                            <!-- Close Browser -->
                            {% if session and session.session_status != 'closed' %}
                            <a href="{% url 'admin_onewin_account_close_browser' account.id %}"
                               class="group relative inline-flex items-center justify-between w-full px-3 py-2 rounded-lg bg-slate-800 text-red-400 hover:bg-red-500/20 hover:text-red-300 transition-all shadow-md hover:shadow-lg"
                               title="Close the current browser session">
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-window-close"></i>
                                    <span class="text-sm font-medium">Close Browser</span>
                                </span>
                                <span class="text-xs text-slate-500">Exit</span>
                                <span class="absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-slate-800 text-xs text-white rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap border border-slate-700 pointer-events-none z-50">
                                    Saves state and closes the browser window
                                </span>
                            </a>
                            {% endif %}

                            <!-- Check Session -->
                            <a href="{% url 'admin_onewin_account_check_session' account.id %}"
                               class="group relative inline-flex items-center justify-between w-full px-3 py-2 rounded-lg bg-slate-800 text-blue-400 hover:bg-blue-500/20 hover:text-blue-300 transition-all shadow-md hover:shadow-lg"
                               title="Check if the user is logged in and session is valid">
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-sync-alt"></i>
                                    <span class="text-sm font-medium">Check Session</span>
                                </span>
                                <span class="text-xs text-slate-500">Verify</span>
                                <span class="absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-slate-800 text-xs text-white rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap border border-slate-700 pointer-events-none z-50">
                                    Tests login status and updates session state
                                </span>
                            </a>

                            <!-- Auto Deposit -->
                            {% if session and session.session_status != 'closed' %}
                            <a href="{% url 'admin_onewin_account_automated_deposit' account.id %}"
                               class="group relative inline-flex items-center justify-between w-full px-3 py-2 rounded-lg bg-slate-800 text-yellow-400 hover:bg-yellow-500/20 hover:text-yellow-300 transition-all shadow-md hover:shadow-lg"
                               title="Perform an automated deposit using saved card">
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-coins"></i>
                                    <span class="text-sm font-medium">Auto Deposit</span>
                                </span>
                                <span class="text-xs text-slate-500">Fund</span>
                                <span class="absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-slate-800 text-xs text-white rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap border border-slate-700 pointer-events-none z-50">
                                    Automates deposit process with saved card
                                </span>
                            </a>
                            {% endif %}

                            <!-- Edit -->
                            <a href="{% url 'admin_onewin_account_edit' account.id %}"
                               class="group relative inline-flex items-center justify-between w-full px-3 py-2 rounded-lg bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white transition-all shadow-md hover:shadow-lg"
                               title="Edit account details">
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-edit"></i>
                                    <span class="text-sm font-medium">Edit</span>
                                </span>
                                <span class="text-xs text-slate-500">Modify</span>
                                <span class="absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-slate-800 text-xs text-white rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap border border-slate-700 pointer-events-none z-50">
                                    Change username, password, or proxy
                                </span>
                            </a>

                            <!-- Delete -->
                            <a href="{% url 'admin_onewin_account_delete' account.id %}"
                               class="group relative inline-flex items-center justify-between w-full px-3 py-2 rounded-lg bg-slate-800 text-red-400 hover:bg-red-500/20 hover:text-red-300 transition-all shadow-md hover:shadow-lg"
                               title="Delete this account permanently">
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-trash"></i>
                                    <span class="text-sm font-medium">Delete</span>
                                </span>
                                <span class="text-xs text-slate-500">Remove</span>
                                <span class="absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-slate-800 text-xs text-white rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap border border-slate-700 pointer-events-none z-50">
                                    Permanently delete account and session data
                                </span>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-slate-500">No accounts found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if accounts.has_other_pages %}
    <div class="px-6 py-4 border-t border-slate-800 flex justify-center">
        <div class="flex gap-2">
            {% if accounts.has_previous %}
                <a href="?page={{ accounts.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="px-3 py-1 bg-slate-800 text-slate-300 rounded hover:bg-slate-700 transition">&laquo;</a>
            {% endif %}

            <span class="px-3 py-1 text-slate-500">Page {{ accounts.number }} of {{ accounts.paginator.num_pages }}</span>

            {% if accounts.has_next %}
                <a href="?page={{ accounts.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="px-3 py-1 bg-slate-800 text-slate-300 rounded hover:bg-slate-700 transition">&raquo;</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}