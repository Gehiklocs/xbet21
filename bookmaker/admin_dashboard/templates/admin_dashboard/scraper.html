{% extends 'admin_dashboard/base.html' %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h2 class="text-3xl font-bold text-white">Scraper Control</h2>
        <p class="text-slate-400">Monitor and control the live odds scraper</p>
    </div>

    <div class="flex items-center gap-4">
        <div class="flex items-center gap-2 px-4 py-2 bg-slate-900 rounded-lg border border-slate-800">
            <div class="w-3 h-3 rounded-full {% if status.is_running %}bg-emerald-500 animate-pulse{% else %}bg-red-500{% endif %}"></div>
            <span class="font-bold {% if status.is_running %}text-emerald-500{% else %}text-red-500{% endif %}">
                {% if status.is_running %}RUNNING{% else %}STOPPED{% endif %}
            </span>
        </div>

        <button onclick="toggleScraper('start')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-bold transition shadow-lg shadow-emerald-900/20 flex items-center gap-2">
            <i class="fas fa-play"></i> Start
        </button>

        <button onclick="toggleScraper('stop')" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold transition shadow-lg shadow-red-900/20 flex items-center gap-2">
            <i class="fas fa-stop"></i> Stop
        </button>
    </div>
</div>

<!-- Terminal -->
<div class="bg-slate-950 rounded-xl border border-slate-800 shadow-2xl overflow-hidden flex flex-col h-[600px]">
    <div class="bg-slate-900 px-4 py-2 border-b border-slate-800 flex items-center gap-2">
        <div class="w-3 h-3 rounded-full bg-red-500"></div>
        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
        <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
        <span class="ml-2 text-xs text-slate-500 font-mono">scraper_logs.log</span>
    </div>

    <div id="log-container" class="flex-1 p-4 overflow-y-auto font-mono text-sm text-emerald-400 whitespace-pre-wrap leading-relaxed">
{{ status.logs }}
    </div>
</div>

<script>
    function toggleScraper(action) {
        // We reuse the existing admin control endpoint for now, or create a new one in this app
        // Let's assume we use the existing one for simplicity, or I should add one to this app's views.
        // Since I didn't add a control view to admin_dashboard/views.py, I'll use the one from scraper_module/admin.py
        // But that one is protected by admin login. Since we are logged in as admin, it should work.
        // URL: /admin/scraper_module/scraperstatus/control/<action>/

        fetch(`/admin/scraper_module/scraperstatus/control/${action}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        }).then(response => response.json()).then(data => {
            if(data.status === 'ok') location.reload();
            else alert(data.message);
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Auto-refresh logs
    setInterval(() => {
        location.reload();
    }, 5000);

    // Scroll to bottom
    const container = document.getElementById('log-container');
    container.scrollTop = container.scrollHeight;
</script>
{% endblock %}
