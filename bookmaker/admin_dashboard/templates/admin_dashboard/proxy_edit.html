{% extends 'admin_dashboard/base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-white">{{ title }}</h2>
        <a href="{% url 'admin_proxies' %}" class="text-slate-400 hover:text-white transition">
            <i class="fas fa-arrow-left mr-2"></i> Back to List
        </a>
    </div>

    <!-- Quick Add Section -->
    <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 mb-6">
        <h3 class="text-lg font-bold text-white mb-4">Quick Add from String</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-400 mb-2">Paste Proxy String</label>
                <div class="flex gap-2">
                    <input type="text" id="proxyString" placeholder="e.g. HTTP: user:pass@ip:port or SOCKS5: user:pass@ip:port"
                           class="flex-1 bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                    <button type="button" onclick="parseProxyString()"
                            class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition">
                        Parse
                    </button>
                </div>
                <p class="text-xs text-slate-500 mt-2">
                    Supported formats:<br>
                    - PROTOCOL: username:password@ip:port<br>
                    - PROTOCOL: ip:port:username:password<br>
                    - ip:port:username:password (defaults to SOCKS5)
                </p>
            </div>
        </div>
    </div>

    <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
        <form method="post" class="space-y-6" id="proxyForm">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="bg-red-500/10 border border-red-500/50 text-red-500 p-4 rounded-lg">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Name -->
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-slate-400 mb-2">Name</label>
                    <input type="text" name="name" id="id_name" value="{{ form.name.value|default:'' }}" required
                           class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                    {% if form.name.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- IP -->
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">IP Address</label>
                    <input type="text" name="ip" id="id_ip" value="{{ form.ip.value|default:'' }}" required
                           class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                    {% if form.ip.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.ip.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Port -->
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Port</label>
                    <input type="number" name="port" id="id_port" value="{{ form.port.value|default:'' }}" required
                           class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                    {% if form.port.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.port.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Type -->
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Type</label>
                    <select name="type" id="id_type" class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                        {% for value, label in form.fields.type.choices %}
                            <option value="{{ value }}" {% if form.type.value == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Country -->
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Country</label>
                    <input type="text" name="country" id="id_country" value="{{ form.country.value|default:'' }}"
                           class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                </div>

                <!-- Username -->
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Username (Optional)</label>
                    <input type="text" name="username" id="id_username" value="{{ form.username.value|default:'' }}"
                           class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                </div>

                <!-- Password -->
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Password (Optional)</label>
                    <input type="text" name="password" id="id_password" value="{{ form.password.value|default:'' }}"
                           class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                </div>

                <!-- Max Uses -->
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Max Uses</label>
                    <input type="number" name="max_uses" value="{{ form.max_uses.value|default:'100' }}"
                           class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                </div>

                <!-- Current Uses -->
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Current Uses</label>
                    <input type="number" name="current_uses" value="{{ form.current_uses.value|default:'0' }}"
                           class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">
                </div>

                <!-- Is Active -->
                <div class="col-span-2 flex items-center">
                    <input type="checkbox" name="is_active" id="id_is_active" {% if form.is_active.value %}checked{% endif %}
                           class="w-4 h-4 text-indigo-600 bg-slate-800 border-slate-700 rounded focus:ring-indigo-500">
                    <label for="id_is_active" class="ml-2 text-sm font-medium text-slate-300">Active</label>
                </div>

                <!-- Notes -->
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-slate-400 mb-2">Notes</label>
                    <textarea name="notes" rows="3"
                              class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:border-indigo-500">{{ form.notes.value|default:'' }}</textarea>
                </div>
            </div>

            <div class="flex justify-end pt-4">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition font-medium">
                    Save Proxy
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function parseProxyString() {
    const input = document.getElementById('proxyString').value.trim();
    if (!input) return;

    let type = 'socks5';
    let cleanInput = input;

    // Check for protocol prefix
    if (input.toUpperCase().startsWith('HTTP:')) {
        type = 'http';
        cleanInput = input.substring(5).trim();
    } else if (input.toUpperCase().startsWith('HTTPS:')) {
        type = 'https';
        cleanInput = input.substring(6).trim();
    } else if (input.toUpperCase().startsWith('SOCKS5:')) {
        type = 'socks5';
        cleanInput = input.substring(7).trim();
    }

    // Try parsing format: user:pass@ip:port
    if (cleanInput.includes('@')) {
        const parts = cleanInput.split('@');
        const auth = parts[0].split(':');
        const address = parts[1].split(':');

        if (auth.length === 2 && address.length === 2) {
            document.getElementById('id_username').value = auth[0];
            document.getElementById('id_password').value = auth[1];
            document.getElementById('id_ip').value = address[0];
            document.getElementById('id_port').value = address[1];
            document.getElementById('id_type').value = type;

            // Auto-generate name
            document.getElementById('id_name').value = `${type.toUpperCase()} - ${address[0]}`;
            return;
        }
    }

    // Try parsing format: ip:port:user:pass
    const parts = cleanInput.split(':');
    if (parts.length === 4) {
        document.getElementById('id_ip').value = parts[0];
        document.getElementById('id_port').value = parts[1];
        document.getElementById('id_username').value = parts[2];
        document.getElementById('id_password').value = parts[3];
        document.getElementById('id_type').value = type;

        // Auto-generate name
        document.getElementById('id_name').value = `${type.toUpperCase()} - ${parts[0]}`;
        return;
    }

    alert('Could not parse proxy string. Please check the format.');
}
</script>
{% endblock %}
